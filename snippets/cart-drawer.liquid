{% comment %}
  Cart Drawer Snippet
  å³ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã—ã¦ãã‚‹ã‚«ãƒ¼ãƒˆãƒ‰ãƒ­ãƒ¯ãƒ¼
{% endcomment %}

{% style %}
  #cart-drawer.invisible {
    visibility: hidden;
  }
{% endstyle %}

<div id="cart-drawer" class="fixed inset-0 z-50 invisible" role="dialog" aria-modal="true">
  <div
    id="cart-drawer-overlay"
    class="absolute inset-0 bg-black/30 transition-opacity opacity-0"
    onclick="closeCartDrawer()"
  ></div>
  <div
    id="cart-drawer-content"
    class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-xl translate-x-full transition-transform duration-300 ease-in-out"
  >
    <div class="flex flex-col h-full">
      <div class="flex items-center justify-between p-4 border-b border-stone-200">
        <h2 class="text-lg font-medium text-stone-800">ã‚«ãƒ¼ãƒˆ</h2>
        <button type="button" onclick="closeCartDrawer()" class="p-2 text-stone-500 hover:text-stone-800">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div id="cart-drawer-items" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
      <div id="cart-drawer-footer" class="p-4 border-t border-stone-200 bg-stone-50">
        <div class="flex justify-between text-base font-medium text-stone-800 mb-4">
          <span>åˆè¨ˆ</span>
          <span id="cart-drawer-total">Â¥0</span>
        </div>
        <div class="space-y-2">
          <a
            href="{{ routes.cart_url }}"
            class="w-full inline-block text-center bg-white border border-stone-300 text-stone-800 py-3 rounded hover:bg-stone-50 transition-colors font-medium"
            >ã‚«ãƒ¼ãƒˆã‚’è¦‹ã‚‹</a
          >
          <form action="{{ routes.cart_url }}" method="post">
            <button
              type="submit"
              name="checkout"
              class="w-full bg-stone-800 text-white py-3 rounded hover:bg-stone-700 transition-colors font-medium"
            >
              è³¼å…¥æ‰‹ç¶šãã¸
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  async function updateCartDrawer() {
    const response = await fetch('/cart.js');
    const cart = await response.json();
    const itemsContainer = document.getElementById('cart-drawer-items');
    const totalContainer = document.getElementById('cart-drawer-total');

    if (cart.items.length === 0) {
      itemsContainer.innerHTML = '<p class="text-center text-stone-500 py-8">ã‚«ãƒ¼ãƒˆã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      totalContainer.innerText = 'Â¥0';
    } else {
      // â˜… æç”»å‰ã«ã€Œãƒ¡ã‚¤ãƒ³å•†å“ã‚’ä¸Šã€ã‚®ãƒ•ãƒˆã‚’ä¸‹ã€ã«å¼·åˆ¶çš„ã«ä¸¦ã³æ›¿ãˆã‚‹
      const sortedItems = [...cart.items].sort((a, b) => {
        const aIsGift = a.handle === 'gift-wrapping' || a.handle === 'message-card';
        const bIsGift = b.handle === 'gift-wrapping' || b.handle === 'message-card';
        if (aIsGift && !bIsGift) return 1;
        if (!aIsGift && bIsGift) return -1;
        return 0;
      });

      const html = sortedItems
        .map((item) => {
          // ç‰¹å®šã®ãƒãƒ³ãƒ‰ãƒ«ä»¥å¤–ã¯ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¡¨ç¤ºã—ãªã„ï¼ˆè¦ä»¶â‘ ã®æ‹…ä¿ï¼‰
          const isGiftItem = item.handle === 'gift-wrapping' || item.handle === 'message-card';
          let propertiesHtml = '';

          if (isGiftItem && item.properties) {
            propertiesHtml = Object.entries(item.properties)
              .filter(([key, value]) => value !== null && value !== '')
              .map(([key, value]) => `<p class="text-xs text-stone-500 mt-1 italic">ğŸ’Œ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${value}</p>`)
              .join('');
          }

          return `
        <div class="flex gap-4">
          <img src="${item.image}" alt="${item.product_title}" class="w-20 h-20 object-cover rounded">
          <div class="flex-1">
            <h3 class="text-sm font-medium text-stone-800">${item.product_title}</h3>
            <p class="text-xs text-stone-500">${item.variant_title || ''}</p>
            ${propertiesHtml}
            <div class="flex justify-between items-end mt-2">
              <span class="text-xs text-stone-600">æ•°é‡: ${item.quantity}</span>
              <span class="text-sm font-medium text-stone-800">Â¥${(item.line_price / 100).toLocaleString()}</span>
            </div>
          </div>
        </div>
      `;
        })
        .join('');

      itemsContainer.innerHTML = html;
      totalContainer.innerText = 'Â¥' + (cart.total_price / 100).toLocaleString();
    }
  }

  function openCartDrawer() {
    const drawer = document.getElementById('cart-drawer');
    const overlay = document.getElementById('cart-drawer-overlay');
    const content = document.getElementById('cart-drawer-content');
    drawer.classList.remove('invisible');
    setTimeout(() => {
      overlay.classList.add('opacity-100');
      content.classList.remove('translate-x-full');
    }, 10);
  }

  function closeCartDrawer() {
    const drawer = document.getElementById('cart-drawer');
    const overlay = document.getElementById('cart-drawer-overlay');
    const content = document.getElementById('cart-drawer-content');
    overlay.classList.remove('opacity-100');
    content.classList.add('translate-x-full');
    setTimeout(() => {
      drawer.classList.add('invisible');
    }, 300);
  }

  // 4.5ç§’ã®å¾…æ©Ÿä»˜ããƒ•ã‚§ãƒƒãƒç›£è¦–ï¼ˆãƒ•ãƒªãƒƒã‚«ãƒ¼é˜²æ­¢ï¼‰
  (function () {
    const originalFetch = window.fetch;
    window.fetch = function (...args) {
      return originalFetch.apply(this, args).then(async (response) => {
        const url = args[0] instanceof Request ? args[0].url : args[0];
        if (response.ok && typeof url === 'string' && url.includes('/cart/add')) {
          setTimeout(async () => {
            await updateCartDrawer();
            openCartDrawer();
          }, 1200);
        }
        return response;
      });
    };
  })();
</script>

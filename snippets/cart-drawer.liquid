{% style %}
  .cart-notification-wrapper {
    display: none;
  }
{% endstyle %}

{% comment %}
  Cart Drawer UI
{% endcomment %}
<div id="cart-drawer" class="fixed inset-0 z-50 invisible" role="dialog" aria-modal="true">
  {% comment %} 背景のオーバーレイ {% endcomment %}
  <div
    id="cart-drawer-overlay"
    class="absolute inset-0 bg-black/30 transition-opacity opacity-0"
    onclick="closeCartDrawer()"
  ></div>

  {% comment %} ドロワー本体 {% endcomment %}
  <div
    id="cart-drawer-content"
    class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-xl translate-x-full transition-transform duration-300 ease-in-out"
  >
    <div class="flex flex-col h-full">
      {% comment %} ヘッダー {% endcomment %}
      <div class="flex items-center justify-between p-4 border-b border-stone-200">
        <h2 class="text-lg font-medium text-stone-800">カート</h2>
        <button type="button" onclick="closeCartDrawer()" class="p-2 text-stone-500 hover:text-stone-800">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      {% comment %} 中身 {% endcomment %}
      <div id="cart-drawer-items" class="flex-1 overflow-y-auto p-4 space-y-4">
        <p class="text-center text-stone-500 py-8">カートを読み込み中...</p>
      </div>

      {% comment %} フッター {% endcomment %}
      <div id="cart-drawer-footer" class="p-4 border-t border-stone-200 bg-stone-50">
        <div class="flex justify-between text-base font-medium text-stone-800 mb-4">
          <span>合計</span>
          <span id="cart-drawer-total">{{ cart.total_price | money }}</span>
        </div>

        <div class="space-y-2">
          <a
            href="{{ routes.cart_url }}"
            class="w-full inline-block text-center bg-white border border-stone-300 text-stone-800 py-3 rounded hover:bg-stone-50 transition-colors font-medium"
          >
            カートを見る
          </a>
          <form action="{{ routes.cart_url }}" method="post">
            <button
              type="submit"
              name="checkout"
              class="w-full bg-stone-800 text-white py-3 rounded hover:bg-stone-700 transition-colors font-medium"
            >
              購入手続きへ
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function openCartDrawer() {
    const drawer = document.getElementById('cart-drawer');
    const overlay = document.getElementById('cart-drawer-overlay');
    const content = document.getElementById('cart-drawer-content');

    drawer.classList.remove('invisible');
    setTimeout(() => {
      overlay.classList.add('opacity-100');
      content.classList.remove('translate-x-full');
    }, 10);

    updateCartDrawer();
  }

  function closeCartDrawer() {
    const drawer = document.getElementById('cart-drawer');
    const overlay = document.getElementById('cart-drawer-overlay');
    const content = document.getElementById('cart-drawer-content');

    overlay.classList.remove('opacity-100');
    content.classList.add('translate-x-full');

    setTimeout(() => {
      drawer.classList.add('invisible');
    }, 300);
  }

  async function updateCartDrawer() {
    const response = await fetch('/cart.js');
    const cart = await response.json();
    const itemsContainer = document.getElementById('cart-drawer-items');
    const totalContainer = document.getElementById('cart-drawer-total');

    if (cart.items.length === 0) {
      itemsContainer.innerHTML = '<p class="text-center text-stone-500 py-8">カートに商品がありません。</p>';
      totalContainer.innerText = '¥0';
      return;
    }

    itemsContainer.innerHTML = cart.items
      .map(
        (item) => `
    <div class="flex gap-4">
      <img src="${item.image}" alt="${item.product_title}" class="w-20 h-20 object-cover rounded">
      <div class="flex-1">
        <h3 class="text-sm font-medium text-stone-800">${item.product_title}</h3>
        <p class="text-xs text-stone-500">${item.variant_title || ''}</p>
        <div class="flex justify-between items-end mt-2">
          <span class="text-xs text-stone-600">数量: ${item.quantity}</span>
          <span class="text-sm font-medium text-stone-800">¥${(item.line_price / 100).toLocaleString()}</span>
        </div>
      </div>
    </div>
  `
      )
      .join('');

    totalContainer.innerText = `¥${(cart.total_price / 100).toLocaleString()}`;
  }

  const originalFetch = window.fetch;
  window.fetch = function () {
    return originalFetch.apply(this, arguments).then(async (response) => {
      if (response.ok && response.url.includes('/cart/add')) {
        openCartDrawer();
      }
      return response;
    });
  };
</script>

<nav class="breadcrumb-bar bg-[#d7ebeb] py-2" aria-label="breadcrumb">
  <div class="max-w-6xl mx-auto px-4">
    <ol class="flex items-center gap-2 text-sm text-gray-700">
      {% comment %} ホーム {% endcomment %}
      <li class="flex items-center">
        <a href="/" class="flex items-center hover:text-gray-900 transition-colors duration-150">
          {% render 'icon-home' %}
        </a>
      </li>

      {% comment %} コレクションページ {% endcomment %}
      {% if template.name == 'collection' %}
        <li class="flex items-center gap-2">
          <span class="text-gray-400">&gt;</span>
          <span>{{ collection.title }}</span>
        </li>
      {% endif %}

      {% comment %} 商品ページ {% endcomment %}
      {% comment %} {% if template.name == 'product' %} {% endcomment %}
      {% comment %} URLパラメータからコレクションハンドルを取得 {% endcomment %}
      {% comment %}
        {% assign collection_param = '' %}
        {% assign url_parts = request.path | split: '?' %}
        {% if canonical_url contains '?' %}
          {% assign url_parts = canonical_url | split: '?' %}
          {% assign query_string = url_parts[1] %}
          {% assign params = query_string | split: '&' %}
          {% for param in params %}
            {% if param contains 'collection=' %}
              {% assign collection_param = param | split: '=' | last %}
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endcomment %}

      {% if template.name == 'product' %}
        <li class="flex items-center gap-2" id="breadcrumb-collection" style="display: none;">
          <span class="text-gray-400">&gt;</span>
          <a href="#" class="hover:text-gray-900 transition-colors duration-150" id="breadcrumb-collection-link"></a>
        </li>
        <li class="flex items-center gap-2" id="breadcrumb-product">
          <span class="text-gray-400">&gt;</span>
          <span>{{ product.title }}</span>
        </li>

        {% comment %} vendorsコレクションかどうかを判定 {% endcomment %}
        {% assign is_vendors_collection = false %}
        {% if collection_param == 'vendors' %}
          {% assign is_vendors_collection = true %}
        {% endif %}

        {% comment %} ブランドページから来た場合は販売元名のみ表示 {% endcomment %}
        {% if is_vendors_collection %}
          <li class="flex items-center gap-2">
            <span class="text-gray-400">&gt;</span>
            <span>{{ product.vendor }}</span>
          </li>
        {% else %}
          {% comment %} 通常のコレクションページから来た場合 {% endcomment %}
          {% if collection_param != '' %}
            {% assign selected_collection = collections[collection_param] %}
            {% if selected_collection %}
              <li class="flex items-center gap-2">
                <span class="text-gray-400">&gt;</span>
                <a href="{{ selected_collection.url }}" class="hover:text-gray-900 transition-colors duration-150">
                  {{ selected_collection.title }}
                </a>
              </li>
            {% endif %}
          {% elsif product.collections.size > 0 %}
            <li class="flex items-center gap-2">
              <span class="text-gray-400">&gt;</span>
              <a href="{{ product.collections.first.url }}" class="hover:text-gray-900 transition-colors duration-150">
                {{ product.collections.first.title }}
              </a>
            </li>
          {% endif %}
          {% comment %} 商品名を表示 {% endcomment %}
          <li class="flex items-center gap-2">
            <span class="text-gray-400">&gt;</span>
            <span>{{ product.title }}</span>
          </li>
        {% endif %}
      {% endif %}

      {% comment %} 検索ページ {% endcomment %}
      {% if template.name == 'search' %}
        <li class="flex items-center gap-2">
          <span class="text-gray-400">&gt;</span>
          <span>検索結果</span>
        </li>
      {% endif %}

      {% comment %} カートページ {% endcomment %}
      {% if template.name == 'cart' %}
        <li class="flex items-center gap-2">
          <span class="text-gray-400">&gt;</span>
          <span>カート</span>
        </li>
      {% endif %}

      {% comment %} その他のページ {% endcomment %}
      {% if template.name == 'page' %}
        <li class="flex items-center gap-2">
          <span class="text-gray-400">&gt;</span>
          <span>{{ page.title }}</span>
        </li>
      {% endif %}
    </ol>
  </div>
</nav>

{% if template.name == 'product' %}
  <script>
  (function() {
    const urlParams = new URLSearchParams(window.location.search);
    const collectionHandle = urlParams.get('collection');
    const breadcrumbCollection = document.getElementById('breadcrumb-collection');
    const breadcrumbProduct = document.getElementById('breadcrumb-product');
    const breadcrumbLink = document.getElementById('breadcrumb-collection-link');

    if (collectionHandle === 'vendors') {
      // ブランドページから来た場合は販売元名のみ
      breadcrumbLink.textContent = '{{ product.vendor }}';
      breadcrumbLink.removeAttribute('href');
      breadcrumbCollection.style.display = 'flex';
      breadcrumbProduct.style.display = 'none';
    } else if (collectionHandle) {
      // コレクションページから来た場合
      fetch(`/collections/${collectionHandle}.json`)
        .then(response => response.json())
        .then(data => {
          breadcrumbLink.textContent = data.collection.title;
          breadcrumbLink.href = `/collections/${collectionHandle}`;
          breadcrumbCollection.style.display = 'flex';
        })
        .catch(() => {
          breadcrumbCollection.style.display = 'none';
        });
    } else {
      // パラメータがない場合は最初のコレクション
      {% if product.collections.size > 0 %}
        breadcrumbLink.textContent = '{{ product.collections.first.title }}';
        breadcrumbLink.href = '{{ product.collections.first.url }}';
        breadcrumbCollection.style.display = 'flex';
      {% else %}
        breadcrumbCollection.style.display = 'none';
      {% endif %}
    }
  })();
  </script>
{% endif %}

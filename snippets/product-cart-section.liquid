{% comment %}
  Product Cart Section
  カート関連機能（バリアント選択、ギフトオプション、カートボタン）

  Parameters:
  - product {Object} 商品オブジェクト
  - section_id {String} セクションID
{% endcomment %}

{% assign has_multiple_variants = false %}
{% if product.variants.size > 1 %}
  {% assign has_multiple_variants = true %}
{% endif %}

{% comment %} マトリックス・バリエーションセレクター {% endcomment %}
<div class="matrix-variant-selector pt-1 mt-1">
  <div class="grid grid-cols-12 gap-2 pb-2 border-b border-gray-200 text-[11px] font-bold text-gray-400 uppercase tracking-wider">
    <div class="col-span-6">
      {% if product.has_only_default_variant %}商品名{% else %}{{ product.options.first }}{% endif %}
    </div>
    <div class="col-span-3 text-right">価格</div>
    <div class="col-span-3 text-center">個数</div>
  </div>

  <div class="space-y-0">
    {% for variant in product.variants %}
      <div
        class="grid grid-cols-12 gap-2 py-4 items-center border-b-2 border-gray-100 js-variant-row"
        data-variant-id="{{ variant.id }}"
      >
        <div class="col-span-6 flex flex-col pr-2">
          <span class="text-sm font-bold text-gray-800 leading-snug break-words">
            {% if product.has_only_default_variant %}
              {{ product.title }}
            {% else %}
              {{ variant.title }}
            {% endif %}
          </span>
          {% if variant.inventory_quantity <= 5 and variant.inventory_quantity > 0 %}
            <span class="text-[10px] text-red-500 font-bold mt-1"
              >残りわずか（{{ variant.inventory_quantity }}個）</span
            >
          {% endif %}
        </div>
        <div class="col-span-3 text-right">
          <span class="text-sm text-gray-700">{{ variant.price | money }}</span>
        </div>
        <div class="col-span-3 flex justify-center">
          <div style="position: relative; width: 64px;">
            <select
              name="updates[{{ variant.id }}]"
              class="js-matrix-quantity"
              style="width: 100%; padding: 6px 20px 6px 8px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; color: #333; font-size: 14px; font-weight: bold; cursor: pointer; appearance: none; -webkit-appearance: none; text-align-last: center;"
            >
              {% for i in (0..10) %}
                <option value="{{ i }}">{{ i }}</option>
              {% endfor %}
            </select>
            <div style="position: absolute; right: 6px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #999; font-size: 8px;">
              ▼
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

{% comment %} ギフトオプション {% endcomment %}
<div class="mt-6 bg-pink-50 border border-pink-200 rounded-lg p-6">
  <h3 class="text-base font-medium text-stone-800 mb-4 flex items-center gap-2">
    <svg class="w-5 h-5 text-pink-500" fill="currentColor" viewBox="0 0 20 20">
      <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
    </svg>
    ギフトオプション
  </h3>

  {% comment %} ギフトラッピング {% endcomment %}
  <div class="mb-4">
    <label class="flex items-start gap-3 cursor-pointer group">
      <input
        type="checkbox"
        name="properties[ギフトラッピング]"
        value="希望する"
        class="mt-1 w-4 h-4 text-stone-800 border-stone-300 rounded focus:ring-stone-500"
      >
      <div class="flex-1">
        <span class="text-sm text-stone-700 group-hover:text-stone-900"> ギフトラッピングを希望する </span>
        <span class="block text-xs text-stone-500 mt-0.5"> + ¥300 </span>
      </div>
    </label>
  </div>

  {% comment %} メッセージカード {% endcomment %}
  <div>
    <label class="flex items-start gap-3 cursor-pointer group mb-2">
      <input
        type="checkbox"
        id="gift-message-toggle"
        class="mt-1 w-4 h-4 text-stone-800 border-stone-300 rounded focus:ring-stone-500"
        onchange="document.getElementById('gift-message-input').classList.toggle('hidden')"
      >
      <div class="flex-1">
        <span class="text-sm text-stone-700 group-hover:text-stone-900"> メッセージカードを追加 </span>
        <span class="block text-xs text-stone-500 mt-0.5"> 無料 </span>
      </div>
    </label>

    <div id="gift-message-input" class="hidden">
      <textarea
        name="properties[ギフトメッセージ]"
        rows="3"
        maxlength="100"
        placeholder="メッセージを入力してください (100文字以内)"
        class="w-full px-3 py-2 text-sm border border-stone-300 rounded focus:outline-none focus:ring-2 focus:ring-stone-500"
      ></textarea>
      <p class="text-xs text-stone-500 mt-1">※ メッセージは100文字以内でご入力ください</p>
    </div>
  </div>
</div>

{% comment %} カートボタン {% endcomment %}
<div class="mt-6">
  {% if has_multiple_variants %}
    {% comment %} バリアントありの場合：カートに追加ボタンのみ {% endcomment %}
    {% form 'product', product, id: 'product-form-{{ section_id }}' %}
      <button
        type="submit"
        name="add"
        id="add-to-cart-button"
        class="w-full h-[45px] bg-black text-white font-bold text-[14px] md:text-sm uppercase tracking-widest flex items-center justify-center hover:bg-gray-800 transition"
      >
        カートに追加する
      </button>
    {% endform %}
  {% else %}
    {% comment %} バリアントなしの場合：カートに追加 + 今すぐ購入 {% endcomment %}
    {% form 'product', product, id: 'product-form-{{ section_id }}' %}
      <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

      <div class="grid grid-cols-2 gap-3 h-[45px] [&_*]:h-full [&_button]:min-h-0 [&_button]:m-0 [&_button]:p-0 [&_button]:rounded-none [&_button]:border-0 [&_button]:p-0">
        <button
          type="submit"
          name="add"
          id="add-to-cart-button"
          class="bg-black text-white font-bold text-[14px] md:text-sm uppercase tracking-widest flex items-center justify-center hover:bg-gray-800 transition"
        >
          カートに追加する
        </button>
        {{ form | payment_button }}
      </div>
    {% endform %}
  {% endif %}
</div>

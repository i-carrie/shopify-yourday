{% comment %}
  Product Cart Section - Final Version with Gift Wrapping
  カート関連機能（バリアント選択、ギフトオプション、カートボタン）

  Parameters:
  - product {Object} 商品オブジェクト
  - section_id {String} セクションID
{% endcomment %}

{% assign has_multiple_variants = false %}
{% assign has_set_product = false %}

{% if product.variants.size > 1 %}
  {% assign has_multiple_variants = true %}
{% endif %}

{% assign related_set = product.metafields.custom.related_set.value %}
{% if related_set != blank %}
  {% assign has_set_product = true %}
{% endif %}

{% comment %} ギフトラッピング商品を取得 {% endcomment %}
{% assign gift_wrapping_product = all_products['gift-wrapping'] %}

{% comment %} フォームの開始 {% endcomment %}
{% if has_multiple_variants or has_set_product %}
  <form
    id="product-form-{{ section_id }}"
    class="product-form"
    data-gift-variant-id="{{ gift_wrapping_product.selected_or_first_available_variant.id }}"
  >
    <div class="matrix-variant-selector pt-1 mt-1">
      <div class="grid grid-cols-12 gap-2 pb-2 border-b border-gray-200 text-[11px] font-bold text-gray-400 uppercase tracking-wider">
        <div class="col-span-6">
          {% if product.has_only_default_variant %}商品名{% else %}{{ product.options.first }}{% endif %}
        </div>
        <div class="col-span-3 text-right">価格</div>
        <div class="col-span-3 text-center">個数</div>
      </div>

      <div class="space-y-0">
        {% for variant in product.variants %}
          <div
            class="grid grid-cols-12 gap-2 py-4 items-center border-b-2 border-gray-100 js-variant-row"
            data-variant-id="{{ variant.id }}"
          >
            <div class="col-span-6 flex flex-col pr-2">
              <span class="text-sm font-bold text-gray-800 leading-snug break-words">
                {% if product.has_only_default_variant %}
                  {{ product.title }}
                {% else %}
                  {{ variant.title }}
                {% endif %}
              </span>
              {% if variant.inventory_quantity <= 5 and variant.inventory_quantity > 0 %}
                <span class="text-[10px] text-red-500 font-bold mt-1"
                  >残りわずか（{{ variant.inventory_quantity }}個）</span
                >
              {% endif %}
            </div>
            <div class="col-span-3 text-right">
              <span class="text-sm text-gray-700">{{ variant.price | money }}</span>
            </div>
            <div class="col-span-3 flex justify-center">
              <div style="position: relative; width: 64px;">
                <select
                  name="updates[{{ variant.id }}]"
                  class="js-matrix-quantity"
                  data-variant-id="{{ variant.id }}"
                  style="width: 100%; padding: 6px 20px 6px 8px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; color: #333; font-size: 14px; font-weight: bold; cursor: pointer; appearance: none; -webkit-appearance: none; text-align-last: center;"
                >
                  {% for i in (0..10) %}
                    <option value="{{ i }}">{{ i }}</option>
                  {% endfor %}
                </select>
                <div style="position: absolute; right: 6px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #999; font-size: 8px;">
                  ▼
                </div>
              </div>
            </div>
          </div>
        {% endfor %}

        {% if has_set_product %}
          {% assign set_variant = related_set.first_available_variant %}
          <div
            class="grid grid-cols-12 gap-2 py-4 items-center border-b-2 border-gray-100 js-variant-row"
            data-variant-id="{{ set_variant.id }}"
          >
            <div class="col-span-6 flex flex-col pr-2">
              <span class="text-sm font-bold text-gray-900 leading-snug">{{ related_set.title }}</span>
              <p class="text-[12px] text-gray-500 mt-1">{{ related_set.metafields.custom.product_subtitle }}</p>
            </div>
            <div class="col-span-3 text-right">
              <div class="flex flex-col">
                {% if related_set.compare_at_price > related_set.price %}
                  <span class="text-[14px] text-pink-700 line-through">{{ related_set.compare_at_price | money }}</span>
                {% endif %}
                <span class="text-sm text-gray-600">{{ related_set.price | money }}</span>
              </div>
            </div>
            <div class="col-span-3 flex justify-center">
              <div style="position: relative; width: 64px;">
                <select
                  name="updates[{{ set_variant.id }}]"
                  class="js-matrix-quantity"
                  data-variant-id="{{ set_variant.id }}"
                  style="width: 100%; padding: 6px 20px 6px 8px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; color: #333; font-size: 14px; font-weight: bold; cursor: pointer; appearance: none; -webkit-appearance: none; text-align-last: center;"
                >
                  {% for i in (0..10) %}
                    <option value="{{ i }}">{{ i }}</option>
                  {% endfor %}
                </select>
                <div style="position: absolute; right: 6px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #999; font-size: 8px;">
                  ▼
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="mt-6 bg-pink-50 border border-pink-200 rounded-lg p-6">
      <h3 class="text-base font-medium text-stone-800 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-pink-500" fill="currentColor" viewBox="0 0 20 20">
          <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
        </svg>
        ギフトオプション
      </h3>

      <div class="mb-4">
        <label class="flex items-start gap-3 cursor-pointer group">
          <input
            type="checkbox"
            id="gift-wrapping-checkbox-{{ section_id }}"
            class="mt-1 w-4 h-4 text-stone-800 border-stone-300 rounded focus:ring-stone-500"
          >
          <div class="flex-1">
            <span class="text-sm text-stone-700 group-hover:text-stone-900"> ギフトラッピングを希望する </span>
            <span class="block text-xs text-stone-500 mt-0.5"> + {{ gift_wrapping_product.price | money }} </span>
          </div>
        </label>
      </div>

      <div>
        <label class="flex items-start gap-3 cursor-pointer group mb-2">
          <input
            type="checkbox"
            id="gift-message-toggle-{{ section_id }}"
            class="mt-1 w-4 h-4 text-stone-800 border-stone-300 rounded focus:ring-stone-500"
            onchange="document.getElementById('gift-message-input-{{ section_id }}').classList.toggle('hidden')"
          >
          <div class="flex-1">
            <span class="text-sm text-stone-700 group-hover:text-stone-900"> メッセージカードを追加 </span>
            <span class="block text-xs text-stone-500 mt-0.5"> 無料 </span>
          </div>
        </label>

        <div id="gift-message-input-{{ section_id }}" class="hidden">
          <textarea
            id="gift-message-textarea-{{ section_id }}"
            rows="3"
            maxlength="100"
            placeholder="メッセージを入力してください (100文字以内)"
            class="w-full px-3 py-2 text-sm border border-stone-300 rounded focus:outline-none focus:ring-2 focus:ring-stone-500"
          ></textarea>
          <p class="text-xs text-stone-500 mt-1">※ メッセージは100文字以内でご入力ください</p>
        </div>
      </div>
    </div>

    <div class="mt-6">
      <button
        type="submit"
        id="add-to-cart-button-{{ section_id }}"
        class="w-full h-[45px] bg-black text-white font-bold text-[14px] md:text-sm uppercase tracking-widest flex items-center justify-center hover:bg-gray-800 transition disabled:opacity-50 disabled:cursor-not-allowed"
      >
        カートに追加する
      </button>
    </div>
  </form>

{% else %}
  <div class="matrix-variant-selector pt-1 mt-1">
    <div class="grid grid-cols-12 gap-2 pb-2 border-b border-gray-200 text-[11px] font-bold text-gray-400 uppercase tracking-wider">
      <div class="col-span-6">商品名</div>
      <div class="col-span-3 text-right">価格</div>
      <div class="col-span-3 text-center">個数</div>
    </div>

    <div class="space-y-0">
      {% assign variant = product.selected_or_first_available_variant %}
      <div
        class="grid grid-cols-12 gap-2 py-4 items-center border-b-2 border-gray-100 js-variant-row"
        data-variant-id="{{ variant.id }}"
      >
        <div class="col-span-6 flex flex-col pr-2">
          <span class="text-sm font-bold text-gray-800 leading-snug break-words">{{ product.title }}</span>
          {% if variant.inventory_quantity <= 5 and variant.inventory_quantity > 0 %}
            <span class="text-[10px] text-red-500 font-bold mt-1"
              >残りわずか（{{ variant.inventory_quantity }}個）</span
            >
          {% endif %}
        </div>
        <div class="col-span-3 text-right">
          <span class="text-sm text-gray-700">{{ variant.price | money }}</span>
        </div>
        <div class="col-span-3 flex justify-center">
          <div style="position: relative; width: 64px;">
            <select
              id="single-product-quantity-{{ section_id }}"
              class="js-matrix-quantity"
              data-variant-id="{{ variant.id }}"
              style="width: 100%; padding: 6px 20px 6px 8px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; color: #333; font-size: 14px; font-weight: bold; cursor: pointer; appearance: none; -webkit-appearance: none; text-align-last: center;"
            >
              {% for i in (0..10) %}
                <option
                  value="{{ i }}"
                  {% if i == 1 %}
                    selected
                  {% endif %}
                >
                  {{ i }}
                </option>
              {% endfor %}
            </select>
            <div style="position: absolute; right: 6px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #999; font-size: 8px;">
              ▼
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-6 bg-pink-50 border border-pink-200 rounded-lg p-6">
    <h3 class="text-base font-medium text-stone-800 mb-4 flex items-center gap-2">
      <svg class="w-5 h-5 text-pink-500" fill="currentColor" viewBox="0 0 20 20">
        <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
      </svg>
      ギフトオプション
    </h3>

    <div class="mb-4">
      <label class="flex items-start gap-3 cursor-pointer group">
        <input
          type="checkbox"
          id="gift-wrapping-checkbox-single-{{ section_id }}"
          class="mt-1 w-4 h-4 text-stone-800 border-stone-300 rounded focus:ring-stone-500"
        >
        <div class="flex-1">
          <span class="text-sm text-stone-700 group-hover:text-stone-900"> ギフトラッピングを希望する </span>
          <span class="block text-xs text-stone-500 mt-0.5"> + {{ gift_wrapping_product.price | money }} </span>
        </div>
      </label>
    </div>

    <div>
      <label class="flex items-start gap-3 cursor-pointer group mb-2">
        <input
          type="checkbox"
          id="gift-message-toggle-single-{{ section_id }}"
          class="mt-1 w-4 h-4 text-stone-800 border-stone-300 rounded focus:ring-stone-500"
          onchange="document.getElementById('gift-message-input-single-{{ section_id }}').classList.toggle('hidden')"
        >
        <div class="flex-1">
          <span class="text-sm text-stone-700 group-hover:text-stone-900"> メッセージカードを追加 </span>
          <span class="block text-xs text-stone-500 mt-0.5"> 無料 </span>
        </div>
      </label>

      <div id="gift-message-input-single-{{ section_id }}" class="hidden">
        <textarea
          id="gift-message-textarea-single-{{ section_id }}"
          rows="3"
          maxlength="100"
          placeholder="メッセージを入力してください (100文字以内)"
          class="w-full px-3 py-2 text-sm border border-stone-300 rounded focus:outline-none focus:ring-2 focus:ring-stone-500"
        ></textarea>
        <p class="text-xs text-stone-500 mt-1">※ メッセージは100文字以内でご入力ください</p>
      </div>
    </div>
  </div>

  <div class="mt-6 grid grid-cols-2 gap-3">
    <form
      id="product-form-{{ section_id }}"
      class="product-form"
      data-gift-variant-id="{{ gift_wrapping_product.selected_or_first_available_variant.id }}"
    >
      <button
        type="submit"
        id="add-to-cart-button-{{ section_id }}"
        class="w-full h-[45px] bg-black text-white font-bold text-[14px] md:text-sm uppercase tracking-widest flex items-center justify-center hover:bg-gray-800 transition disabled:opacity-50 disabled:cursor-not-allowed"
      >
        カートに追加する
      </button>
    </form>

    {% form 'product', product, id: 'buy-now-form-{{ section_id }}' %}
      <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
      <div
        id="buy-now-wrapper-{{ section_id }}"
        class="relative h-[45px] transition-all duration-300 [&_*]:h-full [&_button]:min-h-0 [&_button]:m-0 [&_button]:p-0 [&_button]:rounded-none [&_button]:border-0"
      >
        {{ form | payment_button }}
        <div
          id="buy-now-guard-{{ section_id }}"
          class="absolute inset-0 z-[999] cursor-not-allowed hidden"
          style="background: transparent;"
        ></div>
      </div>
    {% endform %}
  </div>
{% endif %}

<script>
  (function () {
    const formId = 'product-form-{{ section_id }}';
    const buttonId = 'add-to-cart-button-{{ section_id }}';

    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById(formId);
      const button = document.getElementById(buttonId);
      if (!form || !button) return;

      const originalButtonText = button.textContent;
      const giftWrappingVariantId = form.getAttribute('data-gift-variant-id');

      form.addEventListener('submit', async function (e) {
        e.preventDefault();
        const mainItems = [];
        const quantitySelects = document.querySelectorAll('.js-matrix-quantity');

        quantitySelects.forEach((select) => {
          const quantity = parseInt(select.value);
          const variantId = select.getAttribute('data-variant-id');
          if (quantity > 0 && variantId) {
            mainItems.push({ id: variantId, quantity: quantity, properties: {} });
          }
        });

        if (mainItems.length === 0) {
          window.cartAPI?.showToast('数量を選択してください', 'error');
          return;
        }

        button.disabled = true;
        button.textContent = '追加中...';

        try {
          const giftWrap = document.querySelector('[id*="gift-wrapping-checkbox"]:checked');
          const giftMsgToggle = document.querySelector('[id*="gift-message-toggle"]:checked');
          const giftMsgText = document.querySelector('[id*="gift-message-textarea"]');
          const giftMessage = giftMsgToggle && giftMsgText ? giftMsgText.value.trim() : null;
          const MSG_CARD_ID = '45726478368908';
          const itemsToSubmit = [];

          // ★ 手順1: ギフト商品を先に配列へ入れる（これで一番下になる）
          if (giftMessage) {
            if (giftWrap && giftWrappingVariantId) {
              itemsToSubmit.push({
                id: giftWrappingVariantId,
                quantity: 1,
                properties: { ギフトメッセージ: giftMessage },
              });
            } else {
              itemsToSubmit.push({ id: MSG_CARD_ID, quantity: 1, properties: { ギフトメッセージ: giftMessage } });
            }
          } else if (giftWrap && giftWrappingVariantId) {
            itemsToSubmit.push({ id: giftWrappingVariantId, quantity: 1, properties: {} });
          }

          // ★ 手順2: メイン商品を後に配列へ入れる（これが一番上になる）
          mainItems.forEach((item) => itemsToSubmit.push(item));

          // 順番にカートへ追加

          {% comment %} for (const item of itemsToSubmit) {
            await window.cartAPI?.addToCart(item);
          }

          if (window.cartAPI) {
            await window.cartAPI.getCart();
            window.cartAPI.updateCartCount();
            window.cartAPI.showToast('カートに追加しました', 'success');
          }
        } catch (error) {
          window.cartAPI?.showToast('追加に失敗しました', 'error');
        } finally {
          button.disabled = false;
          button.textContent = originalButtonText;
        } {% endcomment %}
        const response = await fetch(window.Shopify.routes.root + 'cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: itemsToSubmit })
          });

          if (response.ok) {
            // 要件①：メッセージを最速で出す
            window.cartAPI?.showToast('カートに追加しました', 'success');

            // 数量更新は裏側で並行して行い、完了次第アイコンを更新する
            // await を付けないことで、トースト表示を止めずに処理を進めるよ
            window.cartAPI?.getCart().then(() => {
              window.cartAPI?.updateCartCount();
            });
          }
      });

      const wrapper = document.getElementById(`buy-now-wrapper-{{ section_id }}`);
      const guard = document.getElementById(`buy-now-guard-{{ section_id }}`);

      const updateBuyNowState = () => {
        const anyGiftChecked = Array.from(document.querySelectorAll('input[type="checkbox"][id*="gift"]')).some(
          (cb) => cb.checked
        );
        if (anyGiftChecked) {
          if (wrapper) {
            wrapper.style.filter = 'grayscale(1)';
            wrapper.style.opacity = '0.4';
            wrapper.style.pointerEvents = 'none';
          }
          if (guard) {
            guard.classList.remove('hidden');
            guard.style.pointerEvents = 'auto';
          }
        } else {
          if (wrapper) {
            wrapper.style.filter = 'none';
            wrapper.style.opacity = '1';
            wrapper.style.pointerEvents = 'auto';
          }
          guard?.classList.add('hidden');
        }
      };

      document.addEventListener('change', (e) => {
        if (e.target.id && e.target.id.includes('gift')) {
          updateBuyNowState();
        }
      });

      guard?.addEventListener(
        'click',
        (e) => {
          e.preventDefault();
          e.stopPropagation();
          window.cartAPI?.showToast('ギフトオプションを選択の場合、今すぐ購入ボタンをご利用できません。', 'error');
        },
        true
      );

      setTimeout(updateBuyNowState, 800);
    });
  })();
</script>
